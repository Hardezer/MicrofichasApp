@model Microfichas_App.Models.FolderFilesViewModel
@{
    ViewData["Title"] = "Folders";
}

<h2>@ViewData["Title"]</h2>
<div class="d-flex justify-content-between mb-3">
    @if (Model.ParentFolderId.HasValue)
    {
        <a asp-action="Index" asp-route-parentFolderId="@Model.GrandParentFolderId" class="btn btn-secondary shadow-sm">Volver</a>
    }
    else
    {
        <a asp-action="Index" controller="Home" class="btn btn-secondary shadow-sm">Volver</a>
    }
    <a asp-action="Create" asp-route-parentFolderId="@Model.ParentFolderId" class="btn btn-primary shadow-sm">Crear Nueva Carpeta</a>
</div>

@if (Model.Breadcrumbs != null && Model.Breadcrumbs.Count > 0)
{
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light shadow-sm">
            @foreach (var breadcrumb in Model.Breadcrumbs)
            {
                <li class="breadcrumb-item">
                    <a asp-action="Index" asp-route-parentFolderId="@breadcrumb.FolderId">@breadcrumb.FolderName</a>
                </li>
            }
        </ol>
    </nav>
}

<table class="table table-striped table-hover shadow-sm">
    <thead class="thead-dark">
        <tr>
            <th>Nombre</th>
            <th>Modificado por</th>
            <th>Modificado el</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var folder in Model.Folders)
        {
            <tr>
                <td>
                    <a asp-action="Index" asp-route-parentFolderId="@folder.FolderId">
                        <img src="~/images/folder-icon.png" alt="Folder Icon" class="icon" />
                        @folder.FolderName
                    </a>
                </td>
                <td>@folder.ModifiedBy</td>
                <td>@(folder.ModifiedDate.HasValue ? folder.ModifiedDate.Value.ToString("dd/MM/yyyy HH:mm") : "")</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary shadow-sm" data-toggle="modal" data-target="#editFolderModal" data-folder-id="@folder.FolderId" data-folder-name="@folder.FolderName">Editar</button>
                    <button class="btn btn-sm btn-outline-danger shadow-sm" data-toggle="modal" data-target="#deleteFolderModal" data-folder-id="@folder.FolderId" data-folder-name="@folder.FolderName">Eliminar</button>
                </td>
            </tr>
        }
        @foreach (var file in Model.Files)
        {
            <tr>
                <td>
                    <a href="@Url.Action("GetFile", new { filePath = file.Server + file.ContainerPath + file.FullFileName })" target="_blank">
                        <img src="~/images/@(file.FileType.ToLower().TrimStart('.'))-icon.png" alt="@file.FileType Icon" class="icon" />
                        @file.FileName
                    </a>
                </td>
                <td>@file.ModifiedBy</td>
                <td>@(file.ModifiedDate.HasValue ? file.ModifiedDate.Value.ToString("dd/MM/yyyy HH:mm") : "")</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary shadow-sm" data-toggle="modal" data-target="#editFileModal" data-file-id="@file.FileId" data-file-name="@file.FileName">Editar</button>
                    <button class="btn btn-sm btn-outline-danger shadow-sm" data-toggle="modal" data-target="#deleteFileModal" data-file-id="@file.FileId" data-file-name="@file.FileName">Eliminar</button>
                </td>
            </tr>
        }

    </tbody>
</table>

<!-- Modal Editar Carpeta -->
<div class="modal fade" id="editFolderModal" tabindex="-1" role="dialog" aria-labelledby="editFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title" id="editFolderModalLabel">Editar Carpeta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editFolderForm">
                    <input type="hidden" id="editFolderId" />
                    <div class="form-group">
                        <label for="editFolderName" class="control-label">Nombre</label>
                        <input type="text" id="editFolderName" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eliminar Carpeta -->
<div class="modal fade" id="deleteFolderModal" tabindex="-1" role="dialog" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFolderModalLabel">Eliminar Carpeta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar esta carpeta?</p>
                <input type="hidden" id="deleteFolderId" />
                <p id="deleteFolderName" class="font-weight-bold"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteFolder">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Archivo -->
<div class="modal fade" id="editFileModal" tabindex="-1" role="dialog" aria-labelledby="editFileModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title" id="editFileModalLabel">Editar Archivo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editFileForm">
                    <input type="hidden" id="editFileId" />
                    <div class="form-group">
                        <label for="editFileName" class="control-label">Nombre</label>
                        <input type="text" id="editFileName" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eliminar Archivo -->
<div class="modal fade" id="deleteFileModal" tabindex="-1" role="dialog" aria-labelledby="deleteFileModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFileModalLabel">Eliminar Archivo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar este archivo?</p>
                <input type="hidden" id="deleteFileId" />
                <p id="deleteFileName" class="font-weight-bold"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteFile">Eliminar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Manejar evento cuando se muestra el modal de editar carpeta
            $('#editFolderModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var folderId = button.data('folder-id');
                var folderName = button.data('folder-name');

                var modal = $(this);
                modal.find('#editFolderId').val(folderId);
                modal.find('#editFolderName').val(folderName);
            });

            // Manejar evento cuando se envía el formulario de editar carpeta
            $('#editFolderForm').submit(function (event) {
                event.preventDefault();

                var folder = {
                    FolderId: $('#editFolderId').val(),
                    FolderName: $('#editFolderName').val()
                };

                $.ajax({
                    url: '@Url.Action("EditFolder", "Folders")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(folder),
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Request failed: ' + error);
                    }
                });
            });

            // Manejar evento cuando se muestra el modal de eliminar carpeta
            $('#deleteFolderModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var folderId = button.data('folder-id');
                var folderName = button.data('folder-name');

                var modal = $(this);
                modal.find('#deleteFolderId').val(folderId);
                modal.find('#deleteFolderName').text(folderName);
            });

            // Manejar evento cuando se confirma la eliminación de carpeta
            $('#confirmDeleteFolder').click(function () {
                var folderId = $('#deleteFolderId').val();

                $.ajax({
                    url: '@Url.Action("DeleteFolder", "Folders")',
                    type: 'POST',
                    data: { id: folderId },
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Request failed: ' + error);
                    }
                });
            });

            // Manejar evento cuando se muestra el modal de editar archivo
            $('#editFileModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var fileId = button.data('file-id');
                var fileName = button.data('file-name');

                var modal = $(this);
                modal.find('#editFileId').val(fileId);
                modal.find('#editFileName').val(fileName);
            });

            // Manejar evento cuando se envía el formulario de editar archivo
            $('#editFileForm').submit(function (event) {
                event.preventDefault();

                var file = {
                    FileId: $('#editFileId').val(),
                    FileName: $('#editFileName').val()
                };

                $.ajax({
                    url: '@Url.Action("EditFile", "Files")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(file),
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Request failed: ' + error);
                    }
                });
            });

            // Manejar evento cuando se muestra el modal de eliminar archivo
            $('#deleteFileModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var fileId = button.data('file-id');
                var fileName = button.data('file-name');

                var modal = $(this);
                modal.find('#deleteFileId').val(fileId);
                modal.find('#deleteFileName').text(fileName);
            });

            // Manejar evento cuando se confirma la eliminación de archivo
            $('#confirmDeleteFile').click(function () {
                var fileId = $('#deleteFileId').val();

                $.ajax({
                    url: '@Url.Action("DeleteFile", "Files")',
                    type: 'POST',
                    data: { id: fileId },
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Request failed: ' + error);
                    }
                });
            });
        });
    </script>
}
